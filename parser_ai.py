import os
import re
import json
import asyncio
from openai import AsyncOpenAI
from dotenv import load_dotenv

load_dotenv()

api_key = os.getenv("OPENAI_API_KEY")
client = AsyncOpenAI(api_key=api_key)

# ------------------ –ù–ê–°–¢–†–û–ô–ö–ò ------------------

LLM_MODEL = "gpt-4o-mini"   # —É—Å—Ç–æ–π—á–∏–≤–µ–µ –Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–∞—Ö
LLM_TIMEOUT = 30             # —Å–µ–∫ –Ω–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
LLM_MAX_CONCURRENCY = 5      # –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ LLM
LLM_MAX_RETRIES = 3          # —Ä–µ—Ç—Ä–∞–∏ –Ω–∞ —Å—Ç—Ä–æ–∫—É

# –¶–µ–Ω–∞: —Å—Ç—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—ã "-20.000", "20.000", "-20,000", "20,000"
PRICE_RE = re.compile(
	r'(?P<price>-?\d{1,3}[.,]\d{3})(?!\d)',  # —á–∏—Å–ª–æ —Å 1‚Äì3 —Ü–∏—Ñ—Ä–∞–º–∏, –∑–∞—Ç–µ–º –∑–∞–ø—è—Ç–∞—è/—Ç–æ—á–∫–∞ –∏ –µ—â—ë 3 —Ü–∏—Ñ—Ä—ã
	re.IGNORECASE
)
EMOJI_RE = re.compile(r'[\U00010000-\U0010ffff]', flags=re.UNICODE)

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: –û–î–ù–ê —Å—Ç—Ä–æ–∫–∞ ‚Üí –û–î–ò–ù –æ–±—ä–µ–∫—Ç
SINGLE_LINE_SYSTEM_PROMPT = """
–¢—ã ‚Äî –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ Telegram-–ø–æ—Å—Ç–∞ –æ –ø—Ä–æ–¥–∞–∂–µ —Ç–µ—Ö–Ω–∏–∫–∏ –∏ —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∏.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑–≤–ª–µ–∫–∞—Ç—å –¢–û–õ–¨–ö–û —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–ª–∞–≥–∞—é—Ç—Å—è –∫ –ø—Ä–æ–¥–∞–∂–µ –∏–ª–∏ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –∫–∞–∫ –ø–æ–∑–∏—Ü–∏–∏ —Å —Ü–µ–Ω–æ–π.
–ò–≥–Ω–æ—Ä–∏—Ä—É–π —Å–ø—Ä–∞–≤–æ—á–Ω—ã–µ, –æ–±—É—á–∞—é—â–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, –æ–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π, —Å—Ç—Ä–∞–Ω, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ç.–¥.).

–ù–∞ –≤—Ö–æ–¥ –ø–æ–¥–∞—é—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ (–∏–ª–∏ –Ω–µ–±–æ–ª—å—à–∏–µ –±–ª–æ–∫–∏) —Ç–µ–∫—Å—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤–µ—Ä–Ω—É—Ç—å —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç JSON –≤–∏–¥–∞:

{
  "–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞": "",
  "–∫–∞—Ç–µ–≥–æ—Ä–∏—è": "",
  "–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è": "",
  "—Ü–≤–µ—Ç": "",
  "–º–æ–¥–µ–ª—å": "",
  "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏": "",
  "—Ü–µ–Ω–∞": ""
}

---
üß≠ –õ–æ–≥–∏–∫–∞:

1. –°—Ç—Ä–æ–∫–∞ –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä, –µ—Å–ª–∏ –≤ –Ω–µ–π —É–∫–∞–∑–∞–Ω–∞ —Ü–µ–Ω–∞ –∏ –µ—Å—Ç—å —Å–ª–æ–≤–∞, –ø–æ—Ö–æ–∂–∏–µ –Ω–∞ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏, –±—Ä–µ–Ω–¥–∞ –∏–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.

2. –ï—Å–ª–∏ –≤ —Å—Ç—Ä–æ–∫–µ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –±—Ä–µ–Ω–¥ (–Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–æ–¥–µ–ª—å—é ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä "Canon PowerShot", "GoPro HERO12", "Fujifilm Instax"), —Å—á–∏—Ç–∞–π —ç—Ç–æ **–±—Ä–µ–Ω–¥–æ–º** –∏ –∑–∞–ø–∏—à–∏ –µ–≥–æ –≤ –ø–æ–ª–µ `"–∫–∞—Ç–µ–≥–æ—Ä–∏—è"`.

3. –ï—Å–ª–∏ —è–≤–Ω–æ–≥–æ –±—Ä–µ–Ω–¥–∞ –Ω–µ—Ç, –Ω–æ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç —É–∑–Ω–∞–≤–∞–µ–º–∞—è –º–æ–¥–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, "A16", "HERO13", "Instax mini 12", "PowerShot"), –ø–æ–ø—Ä–æ–±—É–π –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±—Ä–µ–Ω–¥ –ø–æ –∏–∑–≤–µ—Å—Ç–Ω—ã–º —à–∞–±–ª–æ–Ω–∞–º –º–æ–¥–µ–ª–µ–π. –ï—Å–ª–∏ –º–æ–¥–µ–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∏ —É –æ–¥–Ω–æ–≥–æ –∏–∑ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –±—Ä–µ–Ω–¥–æ–≤ ‚Äî –æ—Å—Ç–∞–≤—å `"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –±—Ä–µ–Ω–¥"`.

4. –ü–æ–ª–µ "–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è" –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤.
   –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —Ç–∏–ø—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å–º–∞—Ä—Ç—Ñ–æ–Ω", "–∫–∞–º–µ—Ä–∞", "–¥—Ä–æ–Ω").
   –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç —Ç–∞–∫–∏—Ö —Å—Ç—Ä–æ–∫-–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, —É–∫–∞–∂–∏ "–ë–µ–∑ —Ç–∏–ø–∞".

5. –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–ª—å–∫–æ —Ü–≤–µ—Ç –∏ —Ü–µ–Ω–∞ –±–µ–∑ –±—Ä–µ–Ω–¥–∞), –∏—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –ø–æ–¥—Å—Ç–∞–≤—å —Ç–æ—Ç –∂–µ –±—Ä–µ–Ω–¥ –∏ —Ç–∏–ø, —á—Ç–æ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ —Å –ø–æ–ª–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º.

6. –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –µ—Å—Ç—å –±—Ä–µ–Ω–¥ ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥—É–±–ª–∏—Ä—É–π –µ–≥–æ –≤ `"–∫–∞—Ç–µ–≥–æ—Ä–∏—è"`.

—Ç–∞–≤—å —ç—Ç–æ –≤–º–µ—Å—Ç–æ —Ç–µ–∫—É—â–∏—Ö –ø—É–Ω–∫—Ç–æ–≤ ‚Äî –æ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Å—Ç—Ä–æ–≥—É—é –ª–æ–≥–∏–∫—É, –Ω–æ –ø–æ–∑–≤–æ–ª–∏—Ç GPT —Å–Ω–æ–≤–∞ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

4. –ü–æ–ª–µ "–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è" –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–≥–ª—è–¥—è—Ç –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤.
   –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —Ç–∏–ø—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—Å–º–∞—Ä—Ç—Ñ–æ–Ω", "–∫–∞–º–µ—Ä–∞", "–¥—Ä–æ–Ω").
   –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –Ω–µ—Ç —Ç–∞–∫–∏—Ö —Å—Ç—Ä–æ–∫-–∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, —É–∫–∞–∂–∏ "–ë–µ–∑ —Ç–∏–ø–∞".

7. –û–ø—Ä–µ–¥–µ–ª–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
   - –ó–∞–≥–æ–ª–æ–≤–∫–æ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ª—é–±–∞—è —Å—Ç—Ä–æ–∫–∞, –∫–æ—Ç–æ—Ä–∞—è:
       ‚Ä¢ —Å—Ç–æ–∏—Ç –æ—Ç–¥–µ–ª—å–Ω–æ (–ø–µ—Ä–µ–¥ –≥—Ä—É–ø–ø–æ–π —Ç–æ–≤–∞—Ä–æ–≤);
       ‚Ä¢ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–Ω, —á–∏—Å–µ–ª –∏–ª–∏ –≤–∞–ª—é—Ç;
       ‚Ä¢ —Å–æ–¥–µ—Ä–∂–∏—Ç 1‚Äì5 —Å–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "GoPro", "Oura Rings", "Whoop", "Camera üì∏", "Redmi Phones");
       ‚Ä¢ –º–æ–∂–µ—Ç –≤–∫–ª—é—á–∞—Ç—å —ç–º–æ–¥–∑–∏, —Å—Å—ã–ª–∫–∏, —Ñ–ª–∞–≥–∏ –∏–ª–∏ —Ç–µ–∫—Å—Ç –≤ —Å–∫–æ–±–∫–∞—Ö (–∏—Ö –Ω—É–∂–Ω–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å);
       ‚Ä¢ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø–∏—Å–∞–Ω–∞ –ó–ê–ì–õ–ê–í–ù–´–ú–ò –±—É–∫–≤–∞–º–∏.
   - –í—Å–µ —Ç–æ–≤–∞—Ä—ã, –∏–¥—É—â–∏–µ –ø–æ—Å–ª–µ —Ç–∞–∫–æ–π —Å—Ç—Ä–æ–∫–∏, –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —ç—Ç–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–æ–∫–∞ –Ω–µ –≤—Å—Ç—Ä–µ—Ç–∏—Ç—Å—è –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞-–∑–∞–≥–æ–ª–æ–≤–æ–∫.
   - –ï—Å–ª–∏ —Ç–∞–∫–∏—Ö —Å—Ç—Ä–æ–∫ –Ω–µ—Å–∫–æ–ª—å–∫–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "GoPro" –∏ –∑–∞—Ç–µ–º "Camera"), –ø–æ—Å–ª–µ–¥–Ω—è—è –∏–∑ –Ω–∏—Ö –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â—É—é –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é.

8. –û—á–∏—Å—Ç–∫–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π:
   - –£–¥–∞–ª–∏ —ç–º–æ–¥–∑–∏, —Ñ–ª–∞–≥–∏, —Å—Å—ã–ª–∫–∏, —Å–∫–æ–±–∫–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã.
   - –ü—Ä–∏–≤–µ–¥–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –≤–∏–¥—É: –ø–µ—Ä–≤–∞—è –±—É–∫–≤–∞ –∑–∞–≥–ª–∞–≤–Ω–∞—è, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–æ—á–Ω—ã–µ
     (–Ω–∞–ø—Ä–∏–º–µ—Ä: "GoPro", "Whoop", "Camera", "Oura Rings").
   - –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ ("PLAID NOTE"), –ø—Ä–∏–≤–µ–¥–∏ –µ—ë –∫ –æ–±—ã—á–Ω–æ–º—É –≤–∏–¥—É ("Plaid Note").

9. –ï—Å–ª–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–∞–∂–µ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ‚Äî —É–∫–∞–∂–∏ "–ë–µ–∑ —Ç–∏–ø–∞".

"""

# ------------------ –ü–û–ú–û–©–ù–ò–ö–ò ------------------

def _stitch_candidates(full_text: str) -> list[str]:
    """
    –°–æ–±–∏—Ä–∞–µ–º –ö–ê–ù–î–ò–î–ê–¢-–°–¢–†–û–ö–ò: —á–∏—Ç–∞–µ–º –í–°–Å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏,
    –≤ –∫–æ—Ç–æ—Ä—ã—Ö –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Ü–µ–Ω–∞. –ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Ç–æ–≤–∞—Ä—ã, —É –∫–æ—Ç–æ—Ä—ã—Ö
    –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω–∞ —Ä–∞–∑–Ω–µ—Å–µ–Ω—ã –ø–æ —Å–æ—Å–µ–¥–Ω–∏–º —Å—Ç—Ä–æ–∫–∞–º, –ø—ã—Ç–∞–µ–º—Å—è —Å–∫–ª–µ–∏—Ç—å 1-2
    –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –ø–µ—Ä–≤–∞—è –±–µ–∑ —Ü–µ–Ω—ã, –∞ —Å–ª–µ–¥—É—é—â–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–Ω—É.
    """
    raw_lines = [EMOJI_RE.sub("", l).strip() for l in full_text.splitlines()]
    raw_lines = [l for l in raw_lines if l]  # —É–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ

    candidates = []
    i = 0
    n = len(raw_lines)
    while i < n:
        line = raw_lines[i]
        if PRICE_RE.search(line):
            candidates.append(line)
            i += 1
            continue

        # –ü—ã—Ç–∞–µ–º—Å—è —Å–∫–ª–µ–∏—Ç—å —Å 1‚Äì2 —Å–ª–µ–¥—É—é—â–∏–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏, –µ—Å–ª–∏ —Ç–∞–º –ø–æ—è–≤–∏—Ç—Å—è —Ü–µ–Ω–∞
        made = False
        for span in (1, 2):
            if i + span < n:
                combo = " ".join(raw_lines[i:i+span+1])
                if PRICE_RE.search(combo):
                    candidates.append(combo)
                    i += span + 1
                    made = True
                    break
        if not made:
            i += 1

    return candidates

# --- —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã ---
def normalize_price(s: str) -> str:
	nums = re.findall(r"\d+", s.replace(",", "").replace(".", "").replace(" ", ""))
	if not nums:
		return ""
	raw = "".join(nums)
	try:
		price = int(raw)
		return f"{price:,} ‚ÇΩ".replace(",", " ")
	except ValueError:
		return ""

# --- —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ ---
def is_valid_item(item: dict) -> bool:
	name = item.get("–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞", "").strip()
	if not name or len(name) < 3:
		return False
	if any(x in name.lower() for x in ["–¥–æ—Å—Ç–∞–≤–∫–∞", "—Ä–∞—Å–ø—Ä–æ–¥–∞–∂–∞", "–∞–∫—Ü–∏—è", "–Ω–æ–≤–∏–Ω–∫–∏", "—Å–∫–∏–¥–∫–∞", "–≥–∞—Ä–∞–Ω—Ç–∏—è"]):
		return False
	if not item.get("—Ü–µ–Ω–∞"):
		return False
	return True

async def _parse_line_with_gpt(line: str, context_before: str = "", context_after: str = "") -> dict | None:
	"""
	–ü–∞—Ä—Å–∏–º –û–î–ù–£ —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ GPT —Å —É—á—ë—Ç–æ–º —Å–æ—Å–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
	"""
	context_text = ""
	if context_before or context_after:
		context_text = (
			"–ö–æ–Ω—Ç–µ–∫—Å—Ç:\n"
			f"–î–æ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –±—ã–ª–æ:\n{context_before.strip()}\n\n"
			f"–ü–æ—Å–ª–µ —ç—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–¥—ë—Ç:\n{context_after.strip()}\n\n"
			"–ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —á–∞—Å—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ–º–∫–æ—Å—Ç—å, —Ü–≤–µ—Ç–∞, —Ä–µ–≥–∏–æ–Ω—ã, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, "
			"–º–æ–¥–µ–ª–∏, –∫–æ–¥—ã –∏ —Ç.–ø.), –∏ –Ω–µ—Ç —è–≤–Ω–æ–π —Ü–µ–Ω—ã ‚Äî –ù–ï —Å—á–∏—Ç–∞–π —ç—Ç–æ —Ç–æ–≤–∞—Ä–æ–º.\n"
		)

	messages = [
		{"role": "system", "content": SINGLE_LINE_SYSTEM_PROMPT},
		{"role": "user", "content": context_text + f"–ê —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç—Ä–æ–∫—É:\n{line.strip()}"}
	]

	try:
		resp = await asyncio.wait_for(
			client.chat.completions.create(
				model=LLM_MODEL,
				messages=messages,
				response_format={"type": "json_object"},
			),
			timeout=LLM_TIMEOUT
		)
	except asyncio.TimeoutError:
		return None
	except Exception as e:
		print(f"‚ö†Ô∏è LLM error: {e}")
		return None

	reply = getattr(resp.choices[0].message, "content", None)
	if not reply or not reply.strip():
		return None

	try:
		data = json.loads(reply)
		if isinstance(data, list):
			data = data[0] if data else None
		if not isinstance(data, dict):
			return None
		return data
	except Exception:
		m = re.search(r"\{.*\}", reply, re.S)
		if not m:
			return None
		try:
			return json.loads(m.group(0))
		except Exception:
			return None

async def _safe_parse_line(lines: list[str], index: int, sem: asyncio.Semaphore) -> dict | None:
	"""
	–ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
	"""
	line = lines[index]
	context_before = "\n".join(lines[max(0, index - 2): index])
	context_after = "\n".join(lines[index + 1: index + 3])

	for attempt in range(LLM_MAX_RETRIES):
		async with sem:
			parsed = await _parse_line_with_gpt(line, context_before, context_after)
		if parsed:
			return parsed
		await asyncio.sleep(0.3 * (attempt + 1))

	# fallback
	m = PRICE_RE.search(line)
	if not m:
		return None
	raw_price = m.group("price")
	price_norm = normalize_price(raw_price)
	name = re.sub(r'\s*[-‚Äì‚Äî:]\s*$', "", line[:m.start()].strip())
	if len(name) < 2:
		return None
	return {
		"–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞": name,
		"–∫–∞—Ç–µ–≥–æ—Ä–∏—è": "",
		"–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è": "",
		"—Ü–≤–µ—Ç": "",
		"–º–æ–¥–µ–ª—å": "",
		"—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏": "",
		"—Ü–µ–Ω–∞": price_norm or raw_price,
	}

# ------------------ –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ------------------

def has_price_like(text: str) -> bool:
	"""
	–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Ü–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
	-20.000 / 20.000 / -20,000 / 20,000
	"""
	return bool(PRICE_RE.search(text))

async def _safe_parse_line(lines: list[str], index: int, sem: asyncio.Semaphore) -> dict | None:
	"""
	–ü—ã—Ç–∞–µ–º—Å—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫—É —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º.
	"""
	line = lines[index]
	context_before = "\n".join(lines[max(0, index - 2): index])
	context_after = "\n".join(lines[index + 1: index + 3])

	for attempt in range(LLM_MAX_RETRIES):
		async with sem:
			parsed = await _parse_line_with_gpt(line, context_before, context_after)
		if parsed:
			return parsed
		await asyncio.sleep(0.3 * (attempt + 1))

	# fallback ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞
	m = PRICE_RE.search(line)
	if not m:
		return None  # –±–µ–∑ —Ü–µ–Ω—ã –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–∑–¥–∞—ë–º
	raw_price = m.group("price")
	price_norm = normalize_price(raw_price)
	name = re.sub(r'\s*[-‚Äì‚Äî:]\s*$', "", line[:m.start()].strip())
	if len(name) < 2:
		return None
	return {
		"–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞": name,
		"–∫–∞—Ç–µ–≥–æ—Ä–∏—è": "",
		"–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è": "",
		"—Ü–≤–µ—Ç": "",
		"–º–æ–¥–µ–ª—å": "",
		"—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏": "",
		"—Ü–µ–Ω–∞": price_norm or raw_price,
	}


async def parse_full_message(text: str) -> list[dict]:
	"""
	1) –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —á—Ç–æ-—Ç–æ –ø–æ—Ö–æ–∂–µ–µ –Ω–∞ —Ü–µ–Ω—É.
	2) –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å—Ä–∞–∑—É –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç (—á—Ç–æ–±—ã –Ω–µ –ø–∞—Ä—Å–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é).
	3) –í—ã–¥–µ–ª—è–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏, –≥–¥–µ –µ—Å—Ç—å —Ü–µ–Ω—ã.
	4) –ü—Ä–æ–≥–æ–Ω—è–µ—Ç –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ GPT.
	5) –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Ç–æ–≤–∞—Ä—ã.
	"""
	# üîπ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ —Ü–µ–Ω–æ–ø–æ–¥–æ–±–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π
	if not has_price_like(text):
		print("‚è© –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ü–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é –ø–æ–ª–Ω–æ—Å—Ç—å—é.")
		return []

	candidates = _stitch_candidates(text)
	print(f"üîé –ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤-—Å—Ç—Ä–æ–∫: {len(candidates)}")

	if not candidates:
		print("‚è© –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫ —Å —Ü–µ–Ω–∞–º–∏ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—é —Å–æ–æ–±—â–µ–Ω–∏–µ.")
		return []

	sem = asyncio.Semaphore(LLM_MAX_CONCURRENCY)
	tasks = [asyncio.create_task(_safe_parse_line(candidates, i, sem)) for i in range(len(candidates))]
	parsed = await asyncio.gather(*tasks)

	results: list[dict] = []
	seen = set()  # –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π (name+price)

	for item in parsed:
		if not item:
			continue

		# –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ü–µ–Ω—É
		if item.get("—Ü–µ–Ω–∞"):
			item["—Ü–µ–Ω–∞"] = normalize_price(str(item["—Ü–µ–Ω–∞"])) or str(item["—Ü–µ–Ω–∞"])

		name = (item.get("–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞") or "").strip()
		price = (item.get("—Ü–µ–Ω–∞") or "").strip()
		if not name or not price:
			continue

		key = (name.lower(), price)
		if key in seen:
			continue
		seen.add(key)

		results.append({
			"–Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞": name,
			"–∫–∞—Ç–µ–≥–æ—Ä–∏—è": item.get("–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "").strip(),
			"–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è": item.get("–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "").strip(),
			"—Ü–≤–µ—Ç": item.get("—Ü–≤–µ—Ç", "").strip(),
			"–º–æ–¥–µ–ª—å": item.get("–º–æ–¥–µ–ª—å", "").strip(),
			"—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏": item.get("—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏", "").strip(),
			"—Ü–µ–Ω–∞": price,
		})

	print(f"‚úÖ –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è: {len(results)}")
	return results
